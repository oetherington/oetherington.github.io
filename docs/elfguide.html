<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><title>ELF for Compiler Writers | Ollie Etherington</title><meta name="description" content="Ollie Etherington"><meta name="viewport" content="width=device-width, initial-scale=1"><meta author="Ollie Etherington"><meta name="keywords" content="ollie,oliver,etherington,london,oxford,programmer"><meta name="msapplication-TileColor" content="#9f00a7"><meta name="theme-color" content="#ffffff"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#272820"><link rel="stylesheet" href="css/styles.css"></head><body><div class="content-full"><div class="link-icons"><a href="https://github.com/oetherington"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div><h2><a href="/">Ollie Etherington<span class="cursor">&nbsp;</span></a></h2><h4>Programmer | Oxford, UK</h4></div><hr><div class="center"><h2><span class="no-mobile">==== </span>ELF for Compiler Writers <span class="no-mobile"> ====</span></h2></div><div class="content centered center"><hr><p><a href="#introduction">1. Introduction</a></p><p><a href="#elf-header">2. ELF Header</a></p><p><a href="#section-header-table">3. Section Header Table</a></p><p><a href="#program-header-table">4. Program Header Table</a></p><p><a href="#symtab-section-entries">5. Symtab Section Entries</a></p><p><a href="#relocation-section-entries">6. Relocation Section Entries</a></p><p><a href="#further-resources">7. Further Resources</a></p><hr></div><div class="content centered"><h1 id="introduction"><a href="#introduction">&gt; Introduction</a></h1>
<p><span class="todo">NOTE:</span> This article is still a work in progress.</p>
<p>This is a short guide describing the ELF file format for those wishing to build
compilers or assemblers that generate ELF files to be fed into a linker. It is
not a comprehensive guide about every last detail of ELF, but rather the
minimum information needed to generate valid object files on Linux. Having now
written a couple of compilers that generate ELF files, this has proven to be
one of the trickiest (and least interesting) steps, and I have written this
article primarily as a reference for myself in the future should I need to
output ELF files again.</p>
<p>In particular, a number of simplifications and generalisations are made below
about ELF files which, while true for this use case, aren't necessarily true in
general. I also present a much more rigid structure below than is actually
required by the ELF specification; this is to allow the precalculation of
several sizes and offsets. For more accurate and more in depth information, see
the resources section at the bottom of the page.</p>
<p>Many of the sections below make reference to the special precalculated offset
<code><span class="hljs-attribute">ELF_BASE</span></code>; this is 0x17d for 32 bit code or ??? for 64 bit code.</p>
<p>It's also possible to learn more about the file format by inspecting the output
from more mature compilers, assemblers and linkers with
<code>objdump -S example.o</code>,
<code>cat example.o | xxd</code> or
<code>readelf -a example.o</code>.</p>
<p>An ELF file is split into three parts:</p>
<ul>
<li>The ELF header which contains general information (including the endianness)</li>
<li>The section header table</li>
<li>The section headers (each corresponding to an entry in the section header
table)</li>
</ul>
<p>An executable would also contain a program header table and program headers,
but these are not present in object files to be passed into a linker.</p>
<p>In the tables below, fields with the size <code>4/8</code> are
4 bytes for 32 bit code and 8 bytes for 64 bit code.</p>
<!--
A reasonably concise implementation of the layout described on this page can be
found in my B compiler, [obc](https://github.com/oetherington/obc).
-->

<h1 id="elf-header"><a href="#elf-header">&gt; ELF Header</a></h1>
<p>First is the ELF header; it consists of the following bytes:</p>
<table>
<thead>
<tr>
<th>Size</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>4</td>
<td>0x464c457f (magic)</td>
</tr>
<tr>
<td>1</td>
<td>1 for 32-bit, 2 for 64-bit</td>
</tr>
<tr>
<td>1</td>
<td>1 for little endian, 2 for big endian</td>
</tr>
<tr>
<td>1</td>
<td>1 (ELF version)</td>
</tr>
<tr>
<td>1</td>
<td>OS ABI - Linux generally uses 0x00 which is System V</td>
</tr>
<tr>
<td>1</td>
<td>0 - more info about the ABI (generally not used)</td>
</tr>
<tr>
<td>7</td>
<td>0 (padding)</td>
</tr>
<tr>
<td>2</td>
<td>File type - 0x01 (<code><span class="hljs-attribute">ET_REL</span></code>) for object files</td>
</tr>
<tr>
<td>2</td>
<td>Architecture (see table below)</td>
</tr>
<tr>
<td>4</td>
<td>1 (ELF version)</td>
</tr>
<tr>
<td>4/8</td>
<td>Start of entry point (0x0 - executables are not discussed here)</td>
</tr>
<tr>
<td>4/8</td>
<td>Start of program header table (0x0)</td>
</tr>
<tr>
<td>4/8</td>
<td>Start of section header table (0x34/0x40 for 32/64 bit)</td>
</tr>
<tr>
<td>4</td>
<td>0 (flags)</td>
</tr>
<tr>
<td>2</td>
<td>Size of this header (0x34/0x40 for 32/64 bit)</td>
</tr>
<tr>
<td>2</td>
<td>Size of a single program header table entry (0x38)</td>
</tr>
<tr>
<td>2</td>
<td>Number of program header table entries (0x0)</td>
</tr>
<tr>
<td>2</td>
<td>Size of a single section header table entry (0x28/0x40 for 32/64 bit)</td>
</tr>
<tr>
<td>2</td>
<td>Number of section header table entries (0x07)</td>
</tr>
<tr>
<td>2</td>
<td>Index of the <code><span class="hljs-title">.shstrtab</span></code> section (0x03)</td>
</tr>
</tbody></table>
<p>The most common architecture values are as follows:</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Architecture</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>None specified</td>
</tr>
<tr>
<td>0x03</td>
<td>x86</td>
</tr>
<tr>
<td>0x3e</td>
<td>x86-64</td>
</tr>
<tr>
<td>0x28</td>
<td>ARM</td>
</tr>
<tr>
<td>0xb7</td>
<td>ARM (64-bits)</td>
</tr>
<tr>
<td>0xf3</td>
<td>RISC-V</td>
</tr>
</tbody></table>
<p>More can be found in the references at the end of the page.</p>
<h1 id="section-header-table"><a href="#section-header-table">&gt; Section Header Table</a></h1>
<p>As seen in the main ELF header, we will use 7 sections, each with a 0x28 byte
header for 32-bit code or 0x40 byte header for 64-bit code. Each section header
consists of the following bytes:</p>
<table>
<thead>
<tr>
<th>Size</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>4</td>
<td>Offset of the header's name in the <code><span class="hljs-title">.shstrtab</span></code> section</td>
</tr>
<tr>
<td>4</td>
<td>Header type (detailed for each section below)</td>
</tr>
<tr>
<td>4/8</td>
<td>Flags</td>
</tr>
<tr>
<td>4/8</td>
<td>Virtual address of the section in memory</td>
</tr>
<tr>
<td>4/8</td>
<td>Offset of the section in the file image</td>
</tr>
<tr>
<td>4/8</td>
<td>Size of the section in bytes (may be 0)</td>
</tr>
<tr>
<td>4</td>
<td>Section index of related section (use depends on section type)</td>
</tr>
<tr>
<td>4</td>
<td>Extra section info (use depends on desction type)</td>
</tr>
<tr>
<td>4/8</td>
<td>Section alignment (must be a power of 2)</td>
</tr>
<tr>
<td>4/8</td>
<td>Size in bytes of each entry, or 0 where not applicable</td>
</tr>
</tbody></table>
<h2 id="index-0-section"><a href="#index-0-section">&gt; Index 0 Section</a></h2>
<p>The first section is the special index 0 section. Every byte is set to 0 for
our use case.</p>
<h2 id="data-section"><a href="#data-section">&gt; Data Section</a></h2>
<p>The second section is the <code>.<span class="hljs-class"><span class="hljs-keyword">data</span></span></code> section which holds static data. The header
is as follows:</p>
<ul>
<li>The shstrtab offset is 1</li>
<li>The type is 0x1 (<code><span class="hljs-attribute">SHT_PROGBITS</span></code>)</li>
<li>The flags are 0x3 (<code>SHF_WRITE <span class="hljs-string">| SHF_ALLOC</span></code>)</li>
<li>The virtual address is 0</li>
<li>The offset in the file image is <code><span class="hljs-attribute">ELF_BASE</span></code></li>
<li>The size of the section must be calculated</li>
<li>The index of the related section is 0</li>
<li>The extra section info is 0</li>
<li>The alignment is 4 for 32 bit code or 8 for 64 bit code</li>
<li>The entry size is 0</li>
</ul>
<h2 id="text-section"><a href="#text-section">&gt; Text Section</a></h2>
<p>The third section is the <code>.<span class="hljs-built_in">text</span></code> section which holds the compiled machine code
itself. The header is as follows:</p>
<ul>
<li>The shstrtab offset is 7</li>
<li>The type is 1 (<code><span class="hljs-attribute">SHT_PROGBITS</span></code>)</li>
<li>The flags are 0x6 (<code>SHF_EXECINSTR <span class="hljs-string">| SHF_ALLOC</span></code>)</li>
<li>The virtual address is 0</li>
<li>The offset in the file image is <code><span class="hljs-attribute">ELF_BASE</span></code> plus the size of the data section</li>
<li>The size of the section must be calculated</li>
<li>The index of the related section is 0</li>
<li>The extra section info is 0</li>
<li>The alignment is 0x10</li>
<li>The entry size is 0</li>
</ul>
<h2 id="shstrtab-section"><a href="#shstrtab-section">&gt; Shstrtab Section</a></h2>
<p>The fourth section is <code><span class="hljs-title">.shstrtab</span></code> which contains the names of the sections as
strings. Note  that the strings must be NULL-terminated and first byte must
also be 0. The header is as follows:</p>
<ul>
<li>The shstrtab offset is 0xd</li>
<li>The type is 0x3 (<code><span class="hljs-attribute">SHT_STRTAB</span></code>)</li>
<li>The flags are 0</li>
<li>The virtual address is 0</li>
<li>The offset in the file image is 0x14c for 32 bit or ??? for 64 bit</li>
<li>The size of the section is 0x31</li>
<li>The index of the related section is 0</li>
<li>The extra section info is 0</li>
<li>The alignment is 0x1</li>
<li>The entry size is 0</li>
</ul>
<p>The layout described in this article has the following data:</p>
<pre><code><span class="hljs-keyword">const</span> <span class="hljs-type">char</span> shstrtab[] = {
    <span class="hljs-number">0</span>, <span class="hljs-string">'.'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'t'</span>, <span class="hljs-string">'a'</span>,
    <span class="hljs-number">0</span>, <span class="hljs-string">'.'</span>, <span class="hljs-string">'t'</span>, <span class="hljs-string">'e'</span> ,<span class="hljs-string">'x'</span>, <span class="hljs-string">'t'</span>,
    <span class="hljs-number">0</span>, <span class="hljs-string">'.'</span>, <span class="hljs-string">'s'</span>, <span class="hljs-string">'h'</span>, <span class="hljs-string">'s'</span>, <span class="hljs-string">'t'</span>, <span class="hljs-string">'r'</span>, <span class="hljs-string">'t'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>,
    <span class="hljs-number">0</span>, <span class="hljs-string">'.'</span>, <span class="hljs-string">'s'</span>, <span class="hljs-string">'y'</span>, <span class="hljs-string">'m'</span>, <span class="hljs-string">'t'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>,
    <span class="hljs-number">0</span>, <span class="hljs-string">'.'</span>, <span class="hljs-string">'s'</span>, <span class="hljs-string">'t'</span>, <span class="hljs-string">'r'</span>, <span class="hljs-string">'t'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>,
    <span class="hljs-number">0</span>, <span class="hljs-string">'.'</span>, <span class="hljs-string">'r'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'l'</span>, <span class="hljs-string">'.'</span>, <span class="hljs-string">'t'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'x'</span>, <span class="hljs-string">'t'</span>,
    <span class="hljs-number">0</span>,
};
</code></pre>
<h2 id="symtab-section"><a href="#symtab-section">&gt; Symtab Section</a></h2>
<p>The fifth section is the symbol table. The header is as follows:</p>
<ul>
<li>The shstrtab offset is 0x17</li>
<li>The type is 0x2 (<code><span class="hljs-attribute">SHT_SYMTAB</span></code>)</li>
<li>The flags are 0</li>
<li>The virtual address is 0</li>
<li>The offset in the file image is <code><span class="hljs-attribute">ELF_BASE</span></code> plus the size of the data
section, the text section and the strtab section</li>
<li>The size of the section must be calculated</li>
<li>The index of the related section is 0x5 (the <code><span class="hljs-title">.strtab</span></code> section which gives
the symbol names)</li>
<li>The extra section info is 0x3 (pointing to this section itself, stating the
location of the relocation data - in more complex senarios this may be in a
separate relocation section)</li>
<li>The alignment is 0x4</li>
<li>The entry size is 0x10</li>
</ul>
<p>The format of the symbol table entries is described
<a href="#symtab-section-entries">below</a>.</p>
<p>Each entry is 0x10 bytes for 32-bit code or 0x18 bytes for 64-bit code, so the
total size will be this times the number of entries.</p>
<h2 id="strtab-section"><a href="#strtab-section">&gt; Strtab Section</a></h2>
<p>The sixth section is the string table. It is pointed to by <code><span class="hljs-title">.symtab</span></code> as it's
related section. The header is as follows:</p>
<ul>
<li>The shstrtab offset is 0x1f</li>
<li>The type is 0x3 (<code><span class="hljs-attribute">SHT_STRTAB</span></code>)</li>
<li>The flags are 0</li>
<li>The virtual address is 0</li>
<li>The offset in the file image is <code><span class="hljs-attribute">ELF_BASE</span></code> plus the size of the data section
and the text section</li>
<li>The size of the section must be calculated</li>
<li>The index of the related section is 0</li>
<li>The extra section info is 0</li>
<li>The alignment is 0x1</li>
<li>The entry size is 0</li>
</ul>
<h2 id="relocation-section"><a href="#relocation-section">&gt; Relocation Section</a></h2>
<p>The seventh and final section is the relocation table.</p>
<ul>
<li>The shstrtab offset is 0x27</li>
<li>The type is 0x9</li>
<li>The flags are 0</li>
<li>The virtual address is 0</li>
<li>The offset in the file image is <code><span class="hljs-attribute">ELF_BASE</span></code> plus the size of the data
section, the text section, the strtab section and the symtab section</li>
<li>The size of the section is the number of entries times the entry size</li>
<li>The index of the related section is 0x4 (the symtab section)</li>
<li>The extra section info is 0x2 (the text section)</li>
<li>The alignment is 0x4</li>
<li>The entry size is 0x8 for 32 bit code or ??? for 64 bit</li>
</ul>
<h1 id="program-header-table"><a href="#program-header-table">&gt; Program Header Table</a></h1>
<p>The program header table and program headers are only required for executable
files, so they are not needed for the use case discussed here. Information about
their use can be found in the resources at the bottom of the page.</p>
<h1 id="symtab-section-entries"><a href="#symtab-section-entries">&gt; Symtab Section Entries</a></h1>
<p>The entries in the symtab have the following structure in a 32-bit ELF file:</p>
<table>
<thead>
<tr>
<th>Size</th>
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>4</td>
<td>name</td>
<td>An index into the strtab section for the section name</td>
</tr>
<tr>
<td>4</td>
<td>value</td>
<td>The offset from the beginning of the symbol's section</td>
</tr>
<tr>
<td>4</td>
<td>size</td>
<td>The size of the symbol</td>
</tr>
<tr>
<td>1</td>
<td>info</td>
<td>The binding and type in the format given below</td>
</tr>
<tr>
<td>1</td>
<td>other</td>
<td>For our purposes here, always 0</td>
</tr>
<tr>
<td>2</td>
<td>shndx</td>
<td>The index of the section header where the symbol is located</td>
</tr>
</tbody></table>
<p>In a 64-bit ELF file, each of the 4 byte entries becomes 8 bytes and they are
reordered as follows: name, info, other, shndx, value, size.</p>
<p>The first symbol table entry is reserved and must be completely filled with
zeros.</p>
<p>The second symbol is the source file name: the name points into the strtab,
the value is 0, the size is 0, the info (see below) has type 0x4 and binding 0,
and the shndx has the special value <code><span class="hljs-attribute">SHN_ABS</span></code> which is 0xfff1.</p>
<p>The third symbol is the text section: all fields are 0 except the type which is
0x3 and the shndx which is 0x2.</p>
<p>After this are the symbols defined in the program.</p>
<h2 id="symtab-entry-info"><a href="#symtab-entry-info">&gt; Symtab Entry Info</a></h2>
<p>The info field holds the symbol's binding and type as
<code>(binding &lt;&lt; <span class="hljs-number">4</span>) + (type &amp; <span class="hljs-number">0xf</span>)</code>. The binding is 0x0 for
static symbols or 0x1 for global symbols. Common symbol types are the following:</p>
<table>
<thead>
<tr>
<th>Value</th>
<th>Name</th>
</tr>
</thead>
<tbody><tr>
<td>0x1</td>
<td>A data object such as a variable or array</td>
</tr>
<tr>
<td>0x2</td>
<td>Executable code such as a function</td>
</tr>
<tr>
<td>0x3</td>
<td>An ELF section</td>
</tr>
<tr>
<td>0x4</td>
<td>The source file name</td>
</tr>
</tbody></table>
<h1 id="relocation-section-entries"><a href="#relocation-section-entries">&gt; Relocation Section Entries</a></h1>
<p><span class="todo">TODO</span></p>
<h1 id="further-resources"><a href="#further-resources">&gt; Further Resources</a></h1>
<p><a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">https://en.wikipedia.org/wiki/Executable_and_Linkable_Format</a></p>
<p><a href="https://cirosantilli.com/elf-hello-world">https://cirosantilli.com/elf-hello-world</a></p>
<p><a href="http://www.sco.com/developers/gabi/2003-12-17/contents.html">http://www.sco.com/developers/gabi/2003-12-17/contents.html</a></p>
<p><a href="https://www.conradk.com/codebase/2017/05/28/elf-from-scratch/">https://www.conradk.com/codebase/2017/05/28/elf-from-scratch/</a></p>
<p><a href="http://www.sunshine2k.de/coding/javascript/onlineelfviewer/onlineelfviewer.html">http://www.sunshine2k.de/coding/javascript/onlineelfviewer/onlineelfviewer.html</a></p>
<p><a href="https://docs.oracle.com/cd/E19683-01/817-3677/chapter6-62988/index.html">https://docs.oracle.com/cd/E19683-01/817-3677/chapter6-62988/index.html</a></p>
<p><a href="https://github.com/torvalds/linux/blob/master/include/uapi/linux/elf.h">https://github.com/torvalds/linux/blob/master/include/uapi/linux/elf.h</a></p>
</div><div class="content footer"><p>Copyright © 2009-2022 Ollie Etherington.</p><p>All content is <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</p></div><br><script src="/instantpage.5.1.0.js" type="module"></script></body></html>